name: "Count Lines of Code of This Repository"
description: "Count Lines Of Code"
inputs:
  build_datetime:
    description: "Build datetime, set by the CI/CD pipeline workflow"
    required: true
  build_timestamp:
    description: "Build timestamp, set by the CI/CD pipeline workflow"
    required: true
  IDP_AWS_REPORT_UPLOAD_ACCOUNT_ID:
    description: "IDP AWS account ID"
    required: true
  IDP_AWS_REPORT_UPLOAD_REGION:
    description: "IDP AWS account region"
    required: true
  IDP_AWS_REPORT_UPLOAD_ROLE_NAME:
    description: "Role to upload the report"
    required: true
  IDP_AWS_REPORT_UPLOAD_BUCKET_ENDPOINT:
    description: "Bucket endpoint for the report"
    required: true
runs:
  using: "composite"
  steps:
    - name: "CLOC repository"
      shell: bash
      run: |
        export BUILD_DATETIME=${{ inputs.build_datetime }}
        ./scripts/reports/cloc-repository.sh
    - name: "Compress CLOC report"
      shell: bash
      run: zip cloc-report.json.zip cloc-report.json
    - name: "Upload CLOC report as an artefact"
      uses: actions/upload-artifact@v3
      with:
        name: cloc-report.json.zip
        path: ./cloc-report.json.zip
    - name: "Check prerequisites for sending the report"
      shell: bash
      id: check
      run: |
        echo "secrets_exist=${{ inputs.IDP_AWS_REPORT_UPLOAD_ROLE_NAME != '' && inputs.IDP_AWS_REPORT_UPLOAD_BUCKET_ENDPOINT != '' }}" >> $GITHUB_OUTPUT
    - name: "Authenticate to send the report"
      if: steps.check.outputs.secrets_exist == 'true'
      uses: aws-actions/configure-aws-credentials@v2
      with:
        role-to-assume: arn:aws:iam::${{ inputs.IDP_AWS_REPORT_UPLOAD_ACCOUNT_ID }}:role/${{ inputs.IDP_AWS_REPORT_UPLOAD_ROLE_NAME }}
        aws-region: ${{ inputs.IDP_AWS_REPORT_UPLOAD_REGION }}
    - name: "Send the CLOC report to the central location"
      shell: bash
      if: steps.check.outputs.secrets_exist == 'true'
      run: |
        aws s3 cp \
          ./cloc-report.json.zip \
          ${{ inputs.IDP_AWS_REPORT_UPLOAD_BUCKET_ENDPOINT }}/${{ inputs.build_timestamp }}-cloc-report.json.zip
